---
- name: pyyx deploy
  hosts: "pyyx_{{environ}}"
  vars:
    root_dir: /data
    folder: "{{environ}}_releases"

  tasks:
    - name: create new verison
      synchronize: src={{root_dir}}/pyyx/ dest=/opt/pyyx/{{folder}}/{{version}}/

    - name: copy conf
      copy: src=/root/workshop/pyyx/src/conf/ dest=/opt/pyyx/{{folder}}/{{version}}/conf/

    - name: link to new version
      file: state=link force=true src=/opt/pyyx/{{folder}}/{{version}} dest=/opt/pyyx/{{environ}}


    - name: delete git
      shell: rm -rf /opt/pyyx/{{folder}}/{{version}}/.git

    - name: reload php
      shell: kill -USR2 `cat /run/php-fpm.pid`

    - name: chown pyyx path to pyyx only test and pre
      shell: "chown -R pyyx:pyyx /opt/pyyx"
      with_items:
        - "{{environ}}"
      when: (item == "pre" or item == "test")

    - name: reload supervisor
      shell: /etc/init.d/supervisord reload
