#第三章 持续交付服务

### 本章起草人：王津银 （优维科技创始人，精益运维提出者） 

## 1. 整体框架
### 1.1 概述
  持续交付是应用运维里面的一个核心服务，它是DevOps的自动化能力的核心，为实现这一能力，需要全面的研发／测试／运维管理能力。本规范就是从构成这一服务的能力要素出发，逐一分解行业的最佳实践，从而为大家提供更多的参考。

### 1.2 框架图
基于持续交付的服务能力，分解如下表：

![](http://7xl5e0.com1.z0.glb.clouddn.com/C3%20001.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C3%20001.jpg

## 2. 最佳实践
### 2.1 持续管理与集成

![](http://7xl5e0.com1.z0.glb.clouddn.com/C3%20002.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C3%20002.jpg

#### 2.1.1 可管理级最佳实践

##### 2.1.1.1 概述
定期的自动化构建与测试。任意一个构建都可以自动化过程重新从源版本控制库上构建。建立了版本化的交付物仓库（Aritifict Repo），对构建结果进行统一管理。

##### 2.1.1.2 最佳实践

- 源代码是集中管理，类似于svn或者git，分布式的版本控制工具对提高研发效率会有帮助.
- 在项目中建使用标准而统一的编码及构建规范，比如说源代码的目录结构，代码编译文件的输出位置等等，确保后续的构建过程是统一化。
- 至少执行每日的自动化构建和测试，提前发现代码的构建问题和一些版本问题（单元测试／验收测试／性能测试等等），该工作可在非工作时间进行，便于提前发现问题。
- 构建过程是自动化的，自动化构建的能力可以随时从源代码的主干或者分支上进行，做到版本可用。
- 版本构建完成之后，构建结果放置到统一的交付物仓库 （Aritifact Repo）中，这个可以和源代码分离管理。类似一个分布式文件系统中集中存放。

#### 2.1.2 已定义级最佳实践
##### 2.1.2.1 概述
能够做到源代码仓库的每一次修改都可以触发进行自动化构建和测试。能够很好的管理项目的外部依赖。能够在不同项目中很好的重用脚本和工具。

##### 2.1.2.2 最佳实践

- 代码提交时可以自动触发构建过程
- 代码的依赖关系被很好的管理，从源头上管理了源代码版本和依赖之间的关系
- 自动化构建和测试的脚本与工具都是可以重复使用的

#### 2.1.3 量化管理级最佳实践
##### 2.1.3.1 概述
构建度量指标的收集，提供可视化工具，在资源和流程确保构建失败时能及时采取行动修复，以免构建长时间失败。

##### 2.1.3.2 最佳实践

- 实时的可视化构建展示平台
- 建立按照项目的自动化每日构建和实时构建平台
- 建立构建的度量指标，比如说构建成功率／自动化测试通过率／代码覆盖率等等

#### 2.1.4 优化管理级最佳实践
##### 2.1.4.1 概述
团队定期碰头，讨论自动化构建过程中遇到的问题。 利用新收集的反馈信息，脚本、工具和可视化平台来解决问题。

##### 2.1.4.2 最佳实践
（暂无）

===
### 2.2 环境管理
#### 2.2.1可管理级最佳实践
##### 2.2.1.1 概述
对应用涉及到的环境有清晰的职责定义和owner定义，并具有在线可视化管理能力。

##### 2.2.1.2 最佳实践之环境的清晰定义和职责管理
对于持续交付过程来说，一次完整的持续发布需要经过开发／测试／预发布／生产等多种环境，对于每一个环境的管理来说，需要有清晰的职责定义，从而确保环境的有效性。一个有效性的环境对于产品的最终质量有很好的控制作用，同时也能避免这个环境不一致带来的奇怪问题。常见的分类如下：

![](http://7xl5e0.com1.z0.glb.clouddn.com/C3%20003.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C3%20003.jpg

- 开发环境。供开发者使用的自测环境。
- 测试环境。供测试人员测试验证的环境，无论是自动化测试还是手工测试环境，但在这个环境中有多个版本同时在并行测试。
- 联调环境。在联调环境中，只有一个待发布版本的验证调试，同时依赖版本也提供了一个独立环境，避免版本测试之间的干扰。
- 预发布环境。也称体验环境，这个环境是对部分用户或者内部用户试用的环境，目的是为了确保功能是否正常，算是一个灰度过程的一部分。
- 生产环境。也称production环境，这个环境是直接面向最终用户的环境。

对以上环境来说，每个环境的管理都需要确定如下管理职责：

- 建立一致的环境管理规范，从OS级／应用级／发布过程级别等维度建立规范要求，特别是测试、预发布及生产环境
- 清晰界定环境管理的角色要求，比如说测试/预发布环境测试人员管理、生产环境运维管理
- 测试人员需要有多测试环境的管理能力，如测试、预发布和联调环境等等
- 环境的管理最终需要通过持续部署平台来固化

##### 2.2.1.3 最佳实践之环境的可视化管理
必须建立环境的标准化管理，把以上的规范要求和职责管理要求全部固化到平台中。在平台中很容易建立如上的管理过程，把持续测试和持续部署的过程打通，让整个过程可视化。如下：

![](http://7xl5e0.com1.z0.glb.clouddn.com/C3%20004.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C3%20004.jpg

#### 2.2.2 已定义级最佳实践
##### 2.2.2.1 概述
开发／测试／生产甚至其它各种环境的标准化和规范化能力是一致的。
建立了标准的环境管理过程。

##### 2.2.2.2 最佳实践之标准化和规范化
- 环境的操作系统版本必须是统一的，比如说操作系统的版本和内核版本是一致的
- OS级别的配置是一致的，最好的情况是公司级是一致的。考虑到业务之间的差异可以做到和应用关联（配置管理）。
- 所有的应用部署相关信息是标准化的，比如说应用包的结构，应用包部署的目录，监控方式，日志清理，应用运行属主等等

##### 2.2.2.3 最佳实践之环境管理过程
- 环境的创建过程是一致的，都是使用持续部署工具创建的，注意要确保所有环境的创建过程是一致的。
- 所有环境的随着版本的升级和变更过程是一致的，是由平台来完成，而非人为完成的。
- 环境的管理过程应该以一个自动化平台为基础，这个平台能覆盖配置管理／应用包发布和持续交付完整自动化交付流等场景。

#### 2.2.3 量化管理级最佳实践
##### 2.2.3.1 概述
所有环境的管理都纳入了运维监控能力范围，提供了容量／可用性／一致性等多种监控手段。

##### 2.2.3.2 最佳实践之运维监控
- 建立以应用为维度的端到端的数据采集体系，完整的指标体系是后续的监控和分析平台的基础。如下图：

![](http://7xl5e0.com1.z0.glb.clouddn.com/C3%20005.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C3%20005.jpg

- 越接近生产环境，越看重以应用为维度的持续反馈和容量及一致性管理能力，统称应用的状态管理。
- 平台需要能过实时生成应用的状态报告，里面包括变更信息／告警信息／状态信息／容量信息／一致性状态等等。
- 考虑到环境的场景和服务的对象不同，在开发环境／测试环境，可以降低对监控／容量管理的要求。

#### 2.2.4 优化管理级最佳实践
（暂无）


===

### 2.3 部署管理
#### 2.3.1 可管理级最佳实践
##### 2.3.1.1 概述
自动化部署到几种环境中。新环境的创建成本非常低。所有的配置不和应用包关联，做到版本控制且分离管理。建立了全面的部署工具集，部署行为可以依赖部署工具集完成。

##### 2.3.1.2 最佳实践
- 建立端到端的部署工具集，基本的分类如下：

![](http://7xl5e0.com1.z0.glb.clouddn.com/C3%20006.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C3%20006.jpg

- 作业交付层是配置管理层的工具和作业能力，从作业对象来说，是针对OS和外部服务化系统对象。前者等同于配置管理，后者去驱动服务系统变更，比如说mysql管理平台。
- 应用交付层是考虑到应用包的变更场景，提供的一个自动化场景。但是这个场景在巨石架构和微服务架构下特征不一样。巨石架构下，版本升级过程无法原子化，依赖很多外部过程来完成；而微服务架构下，版本升级过程可以原子化，不依赖关联的外部过程。
- 业务交付层是一种复杂化的场景化封装的调度流来完成的，比如说巨石架构下的版本升级过程以及业务迁移／扩容／缩容过程等等，完全是场景化驱动的。
- 应用的配置管理能独立和应用的集群建立关联管理，比如说开发／测试／生产集群等等，配置需要和他们建立维度关联，以方便清晰的管理。
- 应用包的配置管理一定要放到包的外部进行管理，最好是放到环境变量中或者转化成KV配置项管理模式，配置的管理成本很低。
- 把配置当成核心的应用信息，需要建立版本管理能力，版本管理／基线管理等等。

#### 2.3.2 已定义级最佳实践
##### 2.3.2.1 概述
软件部署使用全自动、自助服务且一键化得过程，并使用相同的过程向各种环境部署。部署工具集可以通过统一而标准的调度流来统一调度，完成新环境部署。

##### 2.3.2.2 最佳实践

- 以应用为维度建立统一的CMDB配置管理和工具变更过程流，通过CMDB配置管理来驱动变更流。
- 工具集是统一Appstore模式管理的，并对工具集合建立了版本管理，确保工具的历史是可以回溯的。
- 封装了统一的调度引擎，这个引擎能过驱动实时的交付流，能够驱动作业能力和持续部署的能力。

#### 2.3.3 量化管理级最佳实践
##### 2.3.3.1 概述
精心计划的部署管理，对发布和回滚流程进行测试。对于变更的对象要有强制校验的能力，避免变更过程异常。

##### 2.3.3.2 最佳实践

- 建立标准的部署过程分类，不同的部署过程有不同的流程要求

![](http://7xl5e0.com1.z0.glb.clouddn.com/C3%20007.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C3%20007.jpg

- 建立正常版本的统一部署时间窗，集中规范管理变更过程，比如说周二和周四下午放开版本管理。
- 对正常版本来说，建立一个部署流程，确保部署过程是精心组织的。
- 对于版本升级来说，可以使用灰度的能力。灰度又分机器级灰度（运维部署工具可以完成）和业务级别灰度（特性灰度／内容灰度等等）。
- 在运维部署平台内，需要有快速回滚的能力。对于巨石架构来说是一个挑战，因此需要有回滚的测试过程。
- 变更的过程需要有强制的检验能力，版本级检验能力，文件级一致性对比能力，实时的变更状态持续反馈能力等等。


#### 2.3.4 优化管理级最佳实践
（暂无）

===
### 2.4 发布流程管理
#### 2.4.1 可管理级最佳实践
##### 2.4.1.1 概述
发布流程能满足不频繁的执行需要，虽然过程可能繁琐，但是能够可靠的执行。

##### 2.4.1.2 最佳实践

- 每次发布的过程都是研发／测试和运维深度参与的过程，而非运维独立完成。
- 测试、研发部门可以为运维输出详细、可靠的部署文档，执行过程复杂而繁琐。
- 组织建立了一个标准的发布流程，发布流程清晰的定义了职责关系

#### 2.4.2 已定义级最佳实践
##### 2.4.2.1 概述
定义并执行变更管理和审批过程，相关的变更过程是明确而具体的，同时有明确的回滚方案。

##### 2.4.2.2 最佳实践
- 根据发布版本的不同特性，建立了标准的变更和审批控制流程
- 测试已经作为发布过程被很好的执行，甚至是安全也已经被很好的执行
- 在发布之前，对应用程序的性能程序有明确的数据，并且根据业务容量的变化，有自己的临时变更预案
- 发布的灰度和回滚已经有了明确的预案

#### 2.4.3 量化管理级最佳实践
##### 2.4.3.1 概述
环境与应用程序的健康性得到监控，并有前瞻性管理；变更前置时间得到关注和监控。对于变更的对象要有强制校验的能力，避免变更过程异常。

##### 2.4.3.2 最佳实践

- 运维立体化监控系统对应用的环境和程序的健康性有很全面的监控，并能够根据应用生成应用性能采样报告。
- 在发布之前，版本发布对业务容量的影响做了全面预估，并提前做了相应的资源准备。
- 变更的过程是依赖持续交付系统的，整个变更过程和时间是能得到有效控制的。
- 变革的过程是使用平台来固化的，整个变更过程没有被异化的可能。
- 变更完成之后能够从对象本身（版本／文件一致性对比）和对象状态两个维度来描述变更的结果，避免变更过程异常。

#### 2.4.4 优化管理级最佳实践
##### 2.4.4.1 概述
运营和交付团队定期沟通来管理风险，缩短循环周期。

##### 2.4.4.2 最佳实践
（暂无）

===

### 2.5 测试管理
#### 2.5.1 可管理级最佳实践
##### 2.5.1.1 概述
自动化测试是用户故事开发流程输出的一部分。测试行为终止在测试环境，属于面向研发过程的服务质量测试。

##### 2.5.1.2 最佳实践

- 遵循传统的测试方法论，测试是对研发质量的保证，核心的能力是确保研发程序是否有存在bug，对业务需求的满足情况。
- 测试作用能力更多的是在测试环境，没有把测试能力延伸到更多的环境，比如说预发布／生产环境。
- 建立测试驱动研发的敏捷开发文化，能过把测试用例作为用户故事的一部分，从而确保后续测试过程效率和质量。

#### 2.5.2 已定义级最佳实践
##### 2.5.2.1 概述
自动化的单元测试和验收测试，验收测试由专门的测试人员开发。测试是开发过程一部分。测试行为延伸到运维生产环境，完成主动性测试，面向用户的服务质量测试。

##### 2.5.2.2 最佳实践

- 建立明确的单元测试文化，把单元测试作为研发规范过程的一个核心度量。建立单元测试的红黑榜，对好的团队进行奖励，对差的团队提出改进要求。
- 把验收测试做为持续集成的一部分，由测试人员建立验收测试的标准。
- 和测试团队一起提炼可测试性的标准，把可测试性前置到开发过程中，降低后期的测试过程的成本。
- 测试的能力可以延续到线上环境，生产环境需要有测试数据和生产数据的隔离能力。
- 线上的自动化测试结果要实时的保留下来，供业务可用性监控和分析使用。
- 根据自动化测试生成的业务可用性报表可以作为业务可用性的一个重要参考，驱动DevOps持续优化。
- 测试内容分级也属于测试管理挺重要的一部分,比如聚焦在核心流程 。对于互联网产品的大量分支更多是研发自测或垂直合作测试团队测试,  测试制定一定的标准去把控授权出去测试模块的质量。  

#### 2.5.3 量化管理级最佳实践
##### 2.5.3.1 概述
质量度量和趋势跟踪。对于非功能需求进行了定义和度量。

##### 2.5.3.2 最佳实践
- 测试和运维一起开发和使用质量度量单/多指标体系，获取实时的质量指标状态，指标的多与少可以根据业务的具体重要情况来决定。
- 对所有的产品和业务的度量标准建议遵循统一一套标准，这样有利于能力对比。
- 质量的度量指标有业务可用性／产品满意度／用户体验等等。
- 业务可用性可以通过可追踪的事件系统数据或者自动化测试线上模拟系统生成。
- 产品满意度可以通过产品论坛或者appstore的评价情况来分析得出或者通过客服渠道的投诉情况计算得出。
- 用户体验是延时和错误的综合性分析中得出，前提是必须建立这两个数据的采集／处理／分析体系。
- 测试还可以提供一些非功能性的度量指标，比如说服务／接口性能，服务的依赖复杂度等等，方便后续的运维管理。
- 建立测试管理自身的度量,比如测试团队的漏测严重/ 致命bug数、缺陷有效率等。

#### 2.5.4 优化管理级最佳实践
（暂无）

### 2.6 数据管理
#### 2.6.1 可管理级最佳实践
##### 2.6.1.1 概述
对数据库的变更使用自动化脚本完成，而这些脚本与应用的版本相对应

##### 2.6.1.2最佳实践
- 数据库变更的脚本根据应用发布的版本做了对应的管理
- 数据库的变更脚本也需要和应用的构建库统一集中管理，方便回滚

#### 2.6.2 已定义级最佳实践
##### 2.6.2.1概述
数据库变更作为部署流程的一部分自动执行。

##### 2.6.2.2 最佳实践

- 数据库服务作为后台服务，应看作应用的附加资源进行管理
- 数据库变更可以分解成两种变更场景，一种是随应用变更而变更的场景；另外一种是数据库独立变更的场景。
- 随应用变更而变更的场景是一种关联变更场景，可以做作为部署流的一部分自动化执行。
- 数据库独立变更的场景，比如说索引变更等等，此时可以作为数据库变更服务独立执行

#### 2.6.3 量化管理级最佳实践
##### 2.6.3.1 概述
每次部署都进行数据库的升级和回滚测试。对数据库进行监控和优化。

##### 2.6.3.2 最佳实践

- 数据变更是重要的变更，确保升级过程可以回滚，需要对数据库变更场景进行分类
- 数据不变，业务改变。这种是最简单的场景，只要在前面加个nginx做分流即可
- 数据结构不变，取值变化，新的取值对应新的业务。

>例如：假设有一个订单业务，订单类型分为1-手机充值，2-淘宝实物，3-机票，现在新增一种4-酒店类型这种也比较简单，前提是要求原有的老代码健壮性比较强，老系统取到新数据，只要不报错，直接忽略即可；新代码读取新的取值进行业务逻辑处理即可

- 数据结构改变。这种是比较复杂的，不管是灰度还是回滚，比较保险的做法是“绝不删除任何老数据，新的业务操作新数据，新的业务兼容老数据”。

>举例来说：假设有一个学生管理系统设计了一个班级字段，但这个字段内容包含“学院-系别-班级”（例如：计算机学院-软件工程-2001080），现在要拆开为3个列，“学院”、“系别”、“班级”，那么就新增3个列，原有列保留，新系统增加删除修改信息的时候，同时修改4个列（“学院”、“系别”、“班级”、老的“班级”）

- 新业务数据和老数据完全无关。这种也很简单，数据隔离就好，新业务用新表，或者新的存储方式都可以
对数据库有全面的监控能力，并且可以根据采集的指标有profiling的能力。

#### 2.6.4优化管理级最佳实践
##### 2.6.4.1 概述
在两次发布之间建立了数据库性能和部署流程的反馈回路。

##### 2.6.4.2 最佳实践
无

===

### 2.7 配置管理
#### 2.7.1 可管理级最佳实践
##### 2.7.1.1 概述
重建软件所需的内容都进行了版本控制，包括：源代码／配置／构建和部署脚本／数据迁移。业务配置管理是通过文件管理的方式来完成，管理复杂而繁琐。

##### 2.7.1.2 最佳实践
- 配置管理的范畴需要延伸，从基础设施的配置管理到上层应用的配置管理，即全面的CMDB配置管理。
- 基础设施资源的配置管理是面相资源的配置管理方式，需要构建完整的配置及配置对象关系。
- 面向应用的配置管理是以应用为中心的配置管理，构建的是应用及应用对象的配置管理。
- 对所有的进行配置管理，从源代码，编译文件，配置文件到部署脚本等等。
- 频繁提交代码到主干，以便于持续构建，确保代码运行正常
- 业务配置文件必须分离到程序包和源代码包外部进行管理
- 业务配置文件可以作为环境变量进行管理，利用操作系统的环境变量来进行读取
- 必须建立一个构建库来管理所有的编译结果，同时构建库还需要完整的管理软件包的配置、依赖配置和环境配置等等。
- 可视化管理以上的过程，需要借助一个标准的持续部署管理平台，对环境、软件包、部署脚本、软件配置等等做到可视化管理

#### 2.7.2 已定义级最佳实践
##### 2.7.2.1 概述
库和依赖被很好的管理。变更过程决定了版本控制的使用规则。业务级配置管理能力通过环境变量或者云化配置中心来完成。

##### 2.7.2.2 最佳实践

- 库和配置一般通过一些有效的工具进行管理，比如说java的maven，ruby的gems等等。
- 对于一个程序包来说，必须显示的声明所依赖的库和依赖的版本信息，方便版本回溯。
- 必须隔离软件包和系统的全局依赖信息，减少版本的交叉影响 
- 业务级别的配置管理使用环境变量进行管理，并且是和软件的版本与环境相对应的，确保配置信息的可扩展性
- 对于一个海量的分布式系统来说，业务配置管理的变更可以称为一个独立场景，此时可以通过分布式配置中心来统一管理。
- 海量的配置管理需要有快速的配置下发，配置版本对比，配置快速回滚等等能力。
- 用户和密码等敏感信息不应该保存在版本库中
- 对配置项需要有明确的配置命名习惯，这样可以通过配置的信息归类可以找到具体的含义，比如说DB的配置，可以增加DB头来命名。
- 配置中的每个元素，使每个配置元素在整个系统中是唯一的
- 配置信息的模块化，降低配置在模块之间的耦合，减少配置的交叉影响
- 从配置的成熟度来说，建议配置文件模式统一，到配置格式统一，到使用方式统一等等
- 应用程序所依赖的所有外部服务，以及这些服务的版本和配置信息
- 基于应用的拓扑结构被很好的管理，这份配置信息对应用的变更／故障定位和影响评估都有很大的意义。

#### 2.7.3 量化管理级最佳实践
##### 2.7.3.1 概述
开发人员每天至少提交到主干一次。只在需要发布时才会拉分支。

##### 2.7.3.2 最佳实践
- 频繁提交到主干，减少多版本的持续集成带来的合并风险。
- 配置的全面管理覆盖，从基础设施／环境管理／应用及应用配置管理／依赖管理等等，都能够识别出配置管理的准确率。
- 配置的动态管理需要有自动的配置管理能力，而非依赖手工管理能力。

#### 2.7.4 优化管理级最佳实践
无

===
### 2.8 架构管理
#### 2.8.1 可管理级最佳实践
##### 2.8.1.1 概述
所有服务的变更是可以通过webconsole完成的，可视化完成

##### 2.8.1.2 最佳实践
- 识别服务变更的场景分类，比如说服务上线／服务下线等等，这个梳理要注意，第一要面向最终用户；第二要以应用的交付能力为核心度量。
- 分解每个场景化的服务变更动作，比如说服务上线

![](http://7xl5e0.com1.z0.glb.clouddn.com/C3%20008.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C3%20008.jpg

- 把服务变更的动作映射到运维的变更平台中，驱动服务变更过程的webconsole化。

#### 2.8.2 已定义级最佳实践
##### 2.8.2.1 概述
对关联的技术架构服务变更可以通过其提供的API接口来调用完成；应用程序具备运维可管理能力。

##### 2.8.2.2 最佳实践

- 对于技术架构来说，抽象其中的公共服务化能力，比如说分布式RDS／分布式cache服务／分布式消息队列服务等等。
- 把每个后台服务当作应用的附加资源来进行管理，以便纳入统一的cmdb管理。比如说Mysql服务就可以当作应用的附加RDS服务来看待。
- 所有的后台服务都实现了平台化管理，平台化管理其中运维可视化管理，运维场景化管理，运维监控能力以及系统API的对外开放性等等。
- 基于平台化的能力，应用程序具备运维可管理能力。可管理能力遵循了标准的运维变更（发布／升级／回滚等等）过程，运维状态（监控／分析）管理过程等等。

#### 2.8.3 量化管理级最佳实践
##### 2.8.3.1 概述
架构的服务化能力可以从监控／管理／调用能力／调用状态等多个角度衡量。

##### 2.8.3.2 最佳实践

- 架构的服务化能力是可运维能力，其中包括架构的自服务／监控／可视化管理／场景化管理能力等等。
- 架构的服务化能力之自服务需要有运维平台支撑，能够满足不同角色运维管理需要，比如说应用运维／系统运维／研发等等。
- 架构的监控能力是内部的服务状态监测能力和外部服务SDK的状态监控能力。
- 架构的场景化管理能力是能够可视化抽象各种服务的运维变更／故障处理／运营分析场景等等，比如说服务的迁移，故障在线定位，服务的性能优化管理等等。

2.8.4 优化管理级最佳实践
无






