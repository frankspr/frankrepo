# 第五章 监控服务 
### 起草人：梁定安（腾讯SNG运维负责人）

## 1. 整体框架
### 1.1 概述
运维的核心职责：质量、效率、成本。监控能力是应用运维保证业务质量的重要能力，监控能力的强弱可以作为衡量应用运维团队工作出色与否的标准之一。本规范将从四大能力模型的不同成熟度阶段，为读者提供通俗易懂的参考。

![](http://7xl5e0.com1.z0.glb.clouddn.com/C5%20001.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C5%20001.jpg

### 1.2 框架图

![](http://7xl5e0.com1.z0.glb.clouddn.com/C5%20002.jpg)

图片地址：http://7xl5e0.com1.z0.glb.clouddn.com/C5%20002.jpg

## 2. 最佳实践
### 2.1 应用监控能力

应用监控能力是运维为了保障业务质量的表现层或产品化的能力模型，伴随该能力模型发展的同时，监控平台能力、质量管理能力和事件响应及处理能力都必须相应的有所提高，以便更有力的支撑监控表现层的能力提升。本章节通过应用监控能力的框架能力分享，阐述在不同能力阶段的实践经验。

#### 2.1.1 可管理级最佳实践
##### 2.1.1.1 概述
应用监控能力可管理级是处于初级能力模型阶段，运维通过监控能力的建设能够实现常用的监控点部署，根据一般的故障场景总结设计出监控点。此阶段的监控能力是点的监控，多为使用外部获取数据的被动式监控方法，运维在此成熟度下对监控反映的异常事件也多为被驱动式的响应。

##### 2.1.1.2 最佳实践
- 系统日志的监控分析，如dmesg、message等系统日志的监控分析。
- 应用日志的监控分析。
- 被动响应式监控，如收到应用慢或不可用的反馈，被动式监控和排障。
- 外部可用性探测，如外部ping。
- 进程端口级监控，如本地ps等方法。
- 单机容量级监控分析，如CPU、内存、硬盘空间等容量监控。
	
应用监控能力可管理级，对精细化管理的要求不高，能实现对常见系统级或应用进程级的监控分析，即可达到此成熟度模型的要求。

#### 2.1.2 已定义级最佳实践
##### 2.1.2.1 概述
应用监控已定义级，运维的监控能力可灵活根据场景采用主动或被动（埋点或非埋点）的监控方案，较全面的覆盖操作系统、服务端、客户端的应用监控需求，并针对不同场景的监控都有明确的指标衡量服务的可用性或可靠性，运维对生产环境的质量监控有较强的掌控力。

##### 2.1.2.2 最佳实践

- 操作系统监控体系（面），利用探针（agent）系统化的采集操作系统的运营信息，作为监控分析排障用途。如zabbix的操作系统监控能力。
- 浏览器监控体系，针对浏览器应用场景的监控体系，在体系中包含：返回码、测速、H5等监控方案。如嵌入js获取监控信息、自动化测试用例模拟波测。
- 服务端监控体系，针对应用程序的监控，主要有两种方法：
  - 开发人员提前在开发过程中埋入监控逻辑，运维提供上报方法或日志采集的方法将监控数据汇总，供分析、展现、排障使用。
  - 运维通过对应用程序的日志分析，进行有限的数据收集，以达到监控应用服务质量的目的。

- 客户端监控体系，主要包括两种模式：
  - 区别于服务端的监控，客户端根据细分场景的不同制定对应的业务监控逻辑，实时主动上报监控数据流，在运维监控系统中分析，是实时监控能力的体现。如安卓、IOS等不同客户端的监控能力的建设。
  - 客户端埋置监控逻辑定时写入本地日志，在特定的场景下（异常/wifi）触发本地日志上报，运维监控系统接收后，解析日志文件供离线监控分析用户。如安卓的BCI注入的监控方案。
  
  在已定义阶段，应用监控能力已经实现操作系统、服务端、客户端、浏览器的全覆盖，运维借此能很好的对服务的可靠性或可用性进行很好的度量，并以此开展优化工作。

#### 2.1.3 量化管理级最佳实践
##### 2.1.3.1 概述
应用监控在量化管理级，主要强调的是监控数据的灵活应用和关联分析，监控数据中并非只有异常数据才需要运维关注并触发行动，往往在大量的监控数据中，深埋着很多有价值的数据需要运维人员主动挖掘。

##### 2.1.3.2 最佳实践
监控数据的灵活应用和关联分析，聚焦在监控应用方向，主要有以下实践：

- 端到端关联分析，在分布式架构盛行的今天，任何业务逻辑都有可能跨机房、跨网络、跨服务、跨设备来完成，当异常发生时，排障要追溯到根源便需要由大量监控数据汇聚在一起，进行关联分析。此举能有效的收敛监控产生的告警，快速定位目标问题，加速监控排障的效率。如常见的三层互联网架构web层-逻辑层-存储层，通过端到端的监控数据关联分析，当存储层发生异常时，逻辑层和web层都有波及受影响的可能，通过监控数据的关联分析，端到端监控能够精准的判定存储的异常且发生告警通知，将web层和逻辑层发生的异常告警将被收敛。
- 接口级的监控能力，对于应用程序内函数级的调用关联分析，是APM的一个重要课题，也是运维快速排障或优化性能的重要数据支持。例如，通过分析内存的堆栈信息获取安卓客户端代码中相关函数间的调用关系和函数执行的耗时数据。

#### 2.1.4 优化管理级最佳实践
##### 2.1.4.1 概述
应用监控优化管理级，监控能力从程序侧延伸到用户侧，通过用户在互联网上的使用痕迹，通过机器学习等手段，对用户使用业务的言论进行分析，应用监控迈入智能化阶段，并借助全局监控数据的大数据挖掘能力，实现用户体验的精准判断，并与自动化运维能力结合实现智能排障。

##### 2.1.4.2 最佳实践
（暂无）

===

### 2.2 质量体系化能力
质量体系管理能力，主要是助力运维推进标准化规范的动力，是运维贯彻落实质量、效率、成本目标的自上而下的管理办法。因此，质量体系管理能力对运维持续优化监控发现的异常问题，推动根源问题解决的很重要的能力模型。

#### 2.2.1 可管理级最佳实践
##### 2.2.1.1 概要
质量体系管理能力在可管理级成熟度模型下，主要是对操作系统级的监控点的部署有要求，但并未形成明确的度量考核要求。此阶段强调软意识，暂未能形成闭环管控。

##### 2.2.1.2 最佳实践
- 操作系统级监控点的推广要求，如容量监控，dmesg等质量监控点的要求。

#### 2.2.2 已定义级最佳实践
##### 2.2.2.1 概述
已定义级的质量体系管理能力，从上一阶段的点的监控能力进化为面的监控能力，质量体系对指标的度量要求逐渐清晰与明确，运维制定与之要求相应的管理与考核流程，形成闭环式管理监控发现的质量问题，有助于质量的持续优化。

##### 2.2.2.2最佳实践

- 操作系统监控质量体系管理，对操作系统层需监控的指标进行度量化的要求，并制定清晰的目标和响应时间要求。如coredump事件的响应时间。
- 浏览器监控质量体系管理，针对浏览器应用场景的监控体系独有的指标，进行度量与考核要求，并通过对指标的关注和运营，持续优化业务的质量。如http返回码的占比控制，测速数据的考核等。
- 服务端监控质量体系管理，成功率、请求量、延时是服务端监控常用的质量，质量体系管理同样从这3个指标进行度量和考核，要求应用开发负责人与运维通过提升3个指标来对应用程序持续优化。如制定目标成功率提升为99.99%。
- 客户端监控质量体系管理，针对客户端应用场景的监控体系独有的指标，进行度量与考核要求，并通过对指标的关注和运营，持续优化业务的质量。如crash率，耗电量等指标的度量与考核要求。

通过质量体系管理能力的成熟，明确了开发和运维的共同价值目标，都是为了优化用户的体验和应用程序的可用性 。因此，运维在推动落实监控方案和监控指标时，与开发协力打造最适合监控方案，以形成质量考核与运维活动正向推动，是devops概念的实例化。

#### 2.2.3 量化管理级最佳实践
##### 2.2.3.1 概述
质量体系管理能力在量化管理级所覆盖的范围进一步扩大，从按架构分层：操作系统层、服务端、客户端分别的质量考核管理，逐渐进入对端到端的链条式质量度量考核的阶段。质量体系管理实现了数据关联分析，对应用整体的可用性或可靠性度量更加精准与聚焦。

##### 2.2.3.2 最佳实践
- 日志标准化，制定全局标准日志规范，监控数据关联分析时，可通过日志获取丰富的信息，供智能监控与自动化处理能力使用。如全局返回码，根据返回码便可识别出异常的节点。
- 端到端链路质量管理要求，通过对核心链路的整体监控，将多个度量指标：操作系统层、服务端、客户端的指标统一聚集到链路上，集中度量与考核，更贴近用户使用业务的场景，质量体系管理能力更精细化。如用户交易链路的质量度量与考核。
- 接口级调用质量管理要求，按接口级调用的场景，定义相应的度量和考核指标进行要求。如接口间的调用延时度量与考核。
	
	质量体系管理的管控，最直观的就是落地为度量能力与考核要求，一旦企业内部达成统一的质量考核目标，应用运维的监控方案便能轻松的推广与实现。

#### 2.2.4 优化管理级最佳实践
##### 2.2.4.1 概述
质量体系管理能力，技术侧对应可用性和可靠性，用户侧对应用户体验。在优化管理级，要求对用户体验的质量进行度量与考核。并辅以其他技术侧的监控数据进行关联分析，将应用全生命周期监管起来，质量体系管理的考核要求也将贯彻整个生命周期。
##### 2.2.4.2最佳实践
(暂无)

===

### 2.3 事件响应与处置能力
运维救火队员的形象大部分源自于对监控异常事件的快速响应与紧急处理能力。因此，事件响应与处置能力是最能体现运维能力建设好与坏的直接能力模型。

#### 2.3.1 可管理级最佳实践
##### 2.3.1.1 概述
运维对事件响应和处置能力在可管理级阶段，仍处于相对被动的状态，依靠有限的监控点产生的告警，由运维进行一线排障或驱动开发排障，以手工查问题解决问题为主，有值班机制。

##### 2.3.1.2 最佳实践
- 交付一线的运维排障能力。
- 交付24小时值班机制。

#### 2.3.2 已定义级最佳实践
##### 2.3.2.1 概述
应用运维团队在已定义级阶段，随着监控能力的提高，运维对异常事件的感知速度更快，并且通过工具化的建设和监控数据的分析，逐步实现潜在异常提前发现的预警机制，一线二线的排障机制，运维能力的不断提高，使得排障场景运维对开发的依赖度降低。

##### 2.3.2.2 最佳实践
- 异常预警机制，通过经验积累和数据趋势分析，部分监控点的潜在问题可被提前发现，将问题扼杀在摇篮中。如容量的使用趋势可以预测未来一段时间内会出现的高负载。
- 一线工具化，对于常见的排障场景，运维的经验和处理方法被抽象成工具，低阶的运维人员可以通过工具操作，以满足一线排障的要求。
- 二线流程化，在一线无法解决的问题中，二线运维会有闭环的排障分析流程，保证所有流入二线的问题都将有效的被修复，并且不再重复发生。如根源问题分析流程RCA（Root Cause Analysis）。

运维的事件响应与处置能力步入已定义级阶段，意味着运维团队的整理抢险能力已经从手工时代进入工具化时代。

#### 2.3.3 量化管理级最佳实践
##### 2.3.3.1 概述
量化管理级阶段下的事件响应和处置能力，因应用监控能力、质量体系化能力、监控平台能力都实现了端到端的监控数据关联分析，监控整体能力有长足的发展，运维对事件响应和处置能力同样继承了监控关联分析的利好，异常事件告警量经过智能聚类和收敛而数量锐减，运维得以更聚焦核心问题处置上，也得以有更多资源投入自动化运维的能力建设上。

##### 2.3.3.2 最佳实践
- 端到端告警与处理，实现链路监控分析与告警的能力，告警数量将被收敛，对监控平台对数据处理加工的要求将更高。
- 接口级调用异常与处理，代码级的监控能力，需要开发在编码过程中提前埋点，告警精准定位到代码级别，可直接由开发人员处理此类告警。

运维事件响应与处置能力在量化管理级阶段，受惠于监控数据的关联分析，智能化与自动化的事件响应与处理能力都被逐步实现。

#### 2.3.4 优化管理级最佳实践
##### 2.3.4.1 概述
在优化管理级阶段中，事件响应与处置能力就被智能化二合为一，有望实现预警或告警并自动化处理，引入机器学习等大数据技术加强对异常事件的深入学习和分析，并强化业务架构和自动化的建设，异常事件得以被自动处置。

##### 2.3.4.2 最佳实践
（暂无）

### 2.4 监控平台能力
监控平台能力是决定监控产品化或表现层的直接支撑能力，同样是质量体系化能力的数据支持，更是事件响应级处置能力的数据来源。因此，监控平台能力的建设很关键，在本章将阐述监控平台建设的实践要点。
#### 2.4.1 可管理级最佳实践
##### 2.4.1.1 概述
监控平台能力在可管理级阶段，对监控点的数据有集中处理和统计分析的需要，多为依赖手动触发的批量采集脚本，将零散的监控点信息收集并分析，整个过程不能实现自动化，需要人工衔接。

##### 2.4.1.2最佳实践
- 批量采集数据工具，实现数据采集功能，将分布式的本地数据集中管理。如expect实现的采集脚本。
- 监控数据分析工具，零散的非自动衔接的数据分析工具，但能满足对监控数据统计分析的基本诉求。如awk、sed等。

#### 2.4.2 已定义级最佳实践
##### 2.4.2.1 概述
运维能根据监控场景的需求，建设成套监控平台架构，实现数据采集、传输通道、数据处理、可视化展现等能力，此阶段的监控平台架构会按分布式系统设计，可灵活扩展，平台能力能满足应用监控的需要。

##### 2.4.2.2 最佳实践
- 数据采集，监控平台提供支持埋点或非埋点的监控数据采集能力，供应用选择，满足不同场景的监控需求。如数据采集agent，logstash等。
- 传输通道，提供稳定高质量的数据传输服务，用于分布式的监控数据的集中化处理。如http上传、分片、对账等能力。
数据处理，面对大量的监控数据上报，监控平台需支持实时流处理能力和离线的大数据计算能力，以备不同监控分析场景使用。如storm、hadoop等。
- 监控可视化，对不同场景的监控数据分析需求抽象为数据可视化服务，提供通用的聚类、翻译等计算逻辑，以图、表等形式展现。如对ip地址翻译为省份、运营商，成功率提供趋势图分析，返回码提供饼图分析等。
- 告警处理，对于监控异常点的收敛与告警能力，通过引入不同的告警算法，旨在将精准的告警信息推送到合适的人手中。如利用3sigma算法精准计算波动偏差值。
- 监控系统的自我监控，监控系统承担发现业务质量异常的重任，监控系统的高效可靠成为业务质量监控度量的只要因素之一，运维需要在建设监控系统的同时，注意加强对监控系统的可用性管理和监控能力。

#### 2.4.3 量化管理级最佳实践
##### 2.4.3.1 概述
监控平台能力在量化管理级阶段的表现为，监控平台架构的各个功能模块更加独立和产品化，能将监控数据集中加工，并提供通用的数据银行接口，供应用监控表现层的展现形式多样化，同时监控平台自身的健壮性和可靠性更强。

##### 2.4.3.2 最佳实践
- 数据银行，完成所有监控数据的加工处理入库，并灵活根据不同的应用监控场景，封装成通用的接口供监控产品化使用，数据透明给所有有使用数据需求的技术人员，数据获取不再困难。如提供数据检索功能，丰富的数据接口满足各种监控诉求。
- 监控系统的自愈能力，监控平台要完成高可用架构的同时，应建设异常场景的自动恢复能力，保证监控平台在重大故障来临时，自身的高可用性不受影响。如监控系统的容量弹性伸缩。

#### 2.4.4 优化管理级最佳实践
##### 2.4.4.1 概述
监控平台能力在优化管理级阶段，平台对数据加工处理更智能化，可灵活根据监控数据的产品化需要，组织和变更数据计算、翻译、降维等数据处理逻辑，自动适配用户使用监控数据的场景要求，让监控原始数据到数据加工处理到监控可视化产品的过程更高效，以确保用户使用监控产品时的体验最优。监控平台数据处理的能力迈入智能化和自动化。

##### 2.4.4.2 最佳实践
（暂无）











